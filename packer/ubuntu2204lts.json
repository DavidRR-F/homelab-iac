{
  "variables": {
    "temp_password": "{{env `TEMP_PASSWORD`}}",
    "iso_checksum": "{{env `ISO_CHECK_HASH`}}"
  },
  "builders": [{
    "type": "qemu",
    "iso_url": "http://releases.ubuntu.com/22.04/ubuntu-22.04-live-server-amd64.iso",
    "iso_checksum": "{{user `iso_checksum`}}",
    "ssh_username": "admin",
    "ssh_password": "{{user `temp_password`}}",
    "ssh_timeout": "30m",
    "shutdown_command": "echo '{{user `temp_password`}}'| sudo -S shutdown -P now"
  }],
  "provisioners": [
    {
      "type": "file",
      "source": "ansible.pub",
      "destination": "/tmp/ansible.pub"
    }
    {
      "type": "shell",
      "inline": [
        "sudo useradd -m -s /bin/bash ansible",
        "sudo mkdir /home/ansible/.ssh",
        "sudo mv /tmp/ansible.pub > /home/ansible/.ssh/authorized_keys",
        "sudo chown -R ansible:ansible /home/ansible/.ssh",
        "sudo chmod 700 /home/ansible/.ssh",
        "sudo chmod 600 /home/ansible/.ssh/authorized_keys",
        "sudo useradd -m -s /bin/bash admin",
        "echo 'ansible ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/ansible"
      ]
    }
  ]
}

